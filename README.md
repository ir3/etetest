etetest
=======

# エンドツーエンドテストの自動化は CucumberからTunipへ

【はじめに】
【Turnipとは】
【テスト環境の進化・変遷】
【テストと開発】
【内部テストと外部テスト】
【Cucumberの特長】
【なぜCucumberがそれほど普及していないか】
【テストファーストとテストアフター】
【実装者側と利用者側の接点】
【テスト自動化】
【アフターテストでのテスト自動化】
【テストツールの変遷】
【テストツールもベタからメタへ】
【CucumberからTurnipへ】
【テスト自動化の為のツール】
【Turnip入門】
【Turnipのテスト記述実装】

## 【はじめに】
　皆さんCucumberを使っていますか？　RSpec使っていますか？　テストなんか書いてない派ですか？　Test::Unit派ですか？　あるいは minitestばりばりですか？

テストなしには、リリースは有り得ませんので何らかの方法でテストを実施されていることでしょう。

TDD/BDDでテストファーストでテストを仕様・ふるまい記述手段としても利用して開発を進める方式が浸透してきている方面もあります。

この記事では、テストアフターでエンドツーエンドテスト自動化（内部詳細構造に立ち入らず、外部インターフェースにて挙動を確認する）の立場でも使える便利なツールTurnipを紹介します。

## 【Turnipとは】
　Turnipは、 Cucumberによって整備されてきた.featureファイルとxx_steps.rbファイルの構成(Gherkin書式)をRSpec内でテスト実行することができる新鋭のライブラリです。
Capybaraの作者がCucumberの改善案として実装。従来はRSpecとCucumberの２本立てとなっていたテストをRSpecに一本化できる筋の良さで今後の普及が期待されます。


## 【テスト環境の進化・変遷】
Rubyを含めテスト環境は、どんどん進化・変遷しています。 
Rubyには Ruby1.8までxUnitの流れを汲むTest::Unit が標準添付されていましたので、Rails以前は、test:unit を使うのが当然で、その方式は今でも脈々と流れているところはあります。(Ruby1.9からはminitestが標準添付。)
RSpecが登場して、ベタベタなコードでなく、ふるまいを記述して、その実装をテストするというスタイルがDSL定式化による誘導で普及しています。
さらにCucmberが登場し、もう一段メタな記述（feature:機能）から順番に具体化（シナリオ、ステップ）する方式(Gherkin書式)で、feature記述部分は、コードに依存せず、プログラマ以外のステークホルダ（関係者）によっても仕様記述や評価が可能となる世界が開けました。

## 【テストと開発】
Rubyの世界で『テスト』というと実装の範囲でTDD/BDDを前提としたアジャイル開発方式の中の話に終始しがちですが、テストには広範囲なテストの世界があります。

シンプルな分類
1. 慣用命名例その１　　　　　　　　　2.慣用命名例その２
　単体テスト　　　(Unit Test)　　　　　単体テスト　　　(Unit Test)
　結合テスト　(Integration Test)　　 　　組み合わせテスト(Association Test)
　システムテスト　(System Test)　　　 総合テスト　　（General Test）　　
　
テスト屋さんの世界では、次のように分類し各種テストや評価を実施する整理もあります。
1. 機能テスト
2. 境界値テスト
3. レアケーステスト
4. セキュリティ検証
5. 性能評価
6. 可用性評価
7. データ保全性評価

そこにはあまり立ち入らないでざっと大きく分けると、内部テストと外部テストということになります。

## 【内部テストと外部テスト】
別の観点で内部テストと外部テストという分け方もできます。
内部テストは、コードに直接作用して、変数の値を評価するのがメインの「ホワイトボックステスト」。
外部テストは、外部インターフェース（画面etc.)を介して評価してゆく「ブラックボックステスト」。
と整理しておきましょう。

内部テストは実装者の世界、外部テストは実装者以外でもできる世界です。

Cucumberは、実装者だけの内部自動テストの枠から実装者以外の外部自動テストへの拡がりの突破口を開きました。

## 【Cucumberの特長】
Cucumberの特長として、「テストを日本語で記述できる」という点がありました。
諸橋さんの「はじめるCucumber」のCucumberのサンプルからfeatureファイルの内容を一部改変して引用すると、次の記述となります。
http://tatsu-zine.com/books/cuke 

```
#language: ja
フィーチャ: ログインしてユーザを識別できる
　ユーザとして、
　ログイン機能などで自分の情報を識別したい。
　なぜなら、メッセージなどを「自分のもの」として区別したいからだ。
　シナリオ: ユーザ登録してログインする
　　前提"新規ユーザ登録"ページを表示している
　　もし"ログイン名"に"moro"と入力する
　　かつ"E メール"に"xxxxxxxxx@xxx.xxx"と入力する
　　かつ"作成"ボタンをクリックする

　　ならば"こんにちはmoro さん"と表示されていること
```

コードの世界とは、別次元のテスト記述の世界が展開されますね。第三者にもわかりやすいというのは確かでしょう。

このフィーチャ（機能）・シナリオ・ステップの３段階での記述方式(Gherkin書式)で、振る舞いをテストできるというのが、Cucumber の画期的な点でした。

TDD/BDDは、ボトムアップで断片から全体が構成されるというスタイルでした。
Cucumberもその方式を踏襲しているといえるのですが、フィーチャ（機能）ありきで出発することもできるので、トップダウンでの機能テスト構成が可能となったのです。このボトムアップかトップダウンかという違いは実はシステム全体のテスト・評価という観点から見るとかなり大きな進歩です。

## 【開発とテスト】
V字テストの図

## 【テストファーストとテストアフター】
テストファースト
アジャイルの文脈では、TDD/BDDではテストは作りながらの仕様記述方法としても使われます。テストファーストです。テストファーストの利点は、何度も説かれています。
http://jp.rubyist.net/magazine/?0021-Rspec 

テストファーストでのテストは、単体テスト(Unit Test)、結合(組み合わせ)テスト（Integration Testing)段階をカバーします。

テストアフター
出来上がったあとちゃんと動作することを確認するというのがテストの基本です。
従って出来上がったあとの評価の為のテスト、すなわちテストアフターという本流のテスト方法も脈々と流れています。

テストアフターを実施するテスト屋さんは、テスト仕様書をExcelで記述します。
テスト設計にて、仕様書からテストすべき項目を洗い出し列挙しします。またテスト実施後、テスト結果も記述し、保存し管理します。

テストをExcelで設計し、実施し、管理を行うという方式は、脈々と行われています。
それはそれで、磨き抜かれた方法ではあります。

テストアフターでは、単体テスト(Unit Test)、結合(組み合わせ)テスト（Integration Testing)、総合（システム）テスト段階をすべてカバーします。

##【実装者側と利用者側の接点】
実装者側の視点でのTDD/BDDと利用側の視点でのシステムテスト（エンドツーエンドテスト）を図1.でもう少しわかり易く図解してみましょう。

図1. 実装者側と利用者側の接点

【テスト自動化】
CI(継続的インテグレーション)による迅速効率的な繰り返しリリースのためには、テストの自動化は重要なテーマです。

TDD/BDDを実践している場合は、テスト自動化は、簡単です。作りためたテストを整理してまとめて動かせばボトムアップテスト自動化は出来上がりです。

しかしTDD/BDDでテストを作り溜めていない場合はどうやってテスト自動化に取り組めばようのでしょうか？

これは結構大きなテーマです。

## 【アフターテストでのテスト自動化】
既に動作するシステムがあって、それを外部テストし、かつ自動化するという場面で、Cucumberなどのユーザ視点を反映できるツールの存在が見直されます。

外部テストという観点には、ブラウザを自動操作するSelenium-RCというツールの存在もあります。ここは、どんなツールをどう活用してゆくのかが今後とも注力される分野でしょう。
http://docs.seleniumhq.org/docs/05_selenium_rc.jsp 

エンドツーエンドテストや受け入れテストにCucumberを採用するという状況もあります。
これは、TDD/BDDとは異なる文脈で、単体テスト・結合テスト段階から、総合テストも自動化したいというニーズでもあります。

この観点は、置いてきぼりとなっていたところです。

『自動テストのニーズもベタからメタへ』
　unit → integration → System

## 【テストツールの変遷】
テストは大事なのですが、本質は変わらなくても、ツールは次々と変遷してゆきます。
昔は（今でもか）テストはassert するものだったのに、shouldになって定着したら、もうexpect to でないと時代遅れとなるようです。
https://twitter.com/iR3/status/271547557350621185 

RubyのWeb回りでのテストツールの変遷を見てみましょう。
現在（2013.4) は、4. Rails3時代の円熟期です。

1. CGI時代 　runit, test:unit
                       ↓
2. Rails1時代 test:unit
                       ↓
3. Rails2時代 RSpec, Cucumber + Webrat
                       ↓
4. Rails3時代 RSpec(should), Cucumber + Capybara
                       ↓　　　　　　　　　　　　　　　　　　　← 今ここ
5.　　　　　RSpec(expect()to ) + Turnip + Capybara
                       ↓
　--------------------------------------------------------------------
　Rails4時代     :
6.　　　　　minitest + Turnip改 + Capybara さてどうなりますか?

Rails4 で MiniTest + Spork + Guard

http://tkeo.hatenablog.com/entry/2013/01/17/143315 


## 【テストツールもベタからメタへ】
　『テストツールもベタからメタへ』
　ベタ ←――――――――――――――→ メタ
　test:unit→RSpec→Gherkin(Cucumber/Turnip)

〔第一世代：Test::Unit〕
テストの記述は、Rubyプログラムそのもの test_xxx.rb

〔第二世代： RSpec〕
テストの記述は、RSpecのDSL （Rubyで解釈できつつ自然言語（英語）にも近づけた）
xxx_spec.rb
RSpecは Test::Unit でやっていることをDSLで別の書き方にしたもので、その「書き方」によってテストの記述がわかりやすくなりました。

〔第三世代： Gherkin(Cucumber/Turnip)〕
Cucumberにより拡張された書式では、ベタなテストにメタな説明（機能・シナリオ・ステップ）の層（レイヤ）を付加し、そのGherkin書式では、プログラムの実装者でなく、第三者や受け入れ者が記述し理解できる（日本語でも記述できる）道が開かれました。
そのテスト記述は、Gherkin書式の 「Business Readable DSL」といわれるものです。

特長は機能とシナリオとステップを次の２段階で分割して記述するところです。
1. 仕様記述のフィーチャーファイル
　非実装者や日本語でもわかりやすい表現で記述できる xxx.feature

2. xx.featureを具体的に実行するステップファイル
　プログラマの実装の世界の　xxx_steps.rb



PS.)
しかしまあWebkitも捨てられて時代遅れになってゆくのですし
https://twitter.com/iR3/status/323719859286462464 

ということはある時点でCapybara-webkitは衰退。なら早めにphantom.js
に移行するのが吉かもしれません。

## 【なぜCucumberがそれほど普及していないか】
「日本語でテストを記述できる」という特長は、実装者以外にもわかりやすく、また実装フェーズとは独立してテストを記述できるので、もっとテストのやり方の大きな流れとして普及するのかと思いきやなかなか歩みは遅いようです。

次に普及の歩みが遅い理由を４点挙げてみます。
1.  具体的な要素ツールの進化が激しく、バージョンが異なるとすぐに動作しなくなる。

2.  機能・シナリオ・手順（ステップ）を記述する.featuerファイルは良いとして、実際のプログラムレベルを記述するステップファイルの実装には、それなりのスキルが要求され、スケジュールが確保されていないと、負荷が高い。

3. 正規表現を扱う箇所が、敷居を高くしている。

　　結論『Cucumberよさげだけど、結構面倒じゃorz』という実態

4. RSpecでテストして、Cucumberでテストと２重にテストは結構手間で負荷がかかる。

## 【CucumberからTurnipへ】
さてやっと本題に入ります。


Turnipは、Cucumberで普及したのGherkin書式で記述されたテストをRSpec上で実行できるライブラリです。Cucumberの問題点を改善して実装されており、Webシステムでのエンドツーエンドのテストを自動化する際にとても有用です。

Turnipの作者は、Capybaraを開発しているJonas Nicklasさんで
「Mapping steps to regexps is hard」という問題意識で、ライブラリを開発されました。
当然Capybaraとの相性もばっちりです。

“Solving Cucumber's Problems — Elabs”
http://www.elabs.se/blog/30-solving-cucumber-s-problems 

「Cucumberのステップファイル記述と差異は、featureを解釈するステップファイルの記述を正規表現を使っていない点です。プレースホルダー(:keys,:link_name,..)を使って、テストに使うパラメーターを取り出しています。Cucumberの場合、正規表現でステップ記述が煩雑になりがちな点をturnip はカイゼンしています。」
http://oblog.objectclub.jp/lets-try-16 


## 【テスト自動化の為のツール】
テスト自動化のツールとしてTurnipのまわりに次のプロダクツがあります。

### メインツール 

・RSpec
 RSpecはテストを記述するためのドメイン特化言語(DSL:Domain Specific Language)を提供するフレームワーク

・Gherkin
 Gherkinは「Business Readable DSL」と称されるところの機能とシナリオとステップを定義してゆくfeatureファイルの記述方式(Gherkin書式)の操作ライブラリ
Cucumberですすめられ、gherkinのgemに括り出されているので、Turnipでも共通で利用できる

・Capybara
　Capybara はブラウザのUIの自動テストする際に、テキスト入力やボタンクリックや表示結果を確認するなどに便利なAPI(語彙)を提供するラヘルパーライブラリ

・@netwillnetさんの Capybara README意訳    http://d.hatena.ne.jp/willnet/20110704/1309782442 より
` Capybara の DSL は Webrat からインスパイアしています。多くのケースで後方互換性を保っている一方、重要な違いもいくつかあります。Webrat とは異なり、Capybara は 全ての検索で case sensitive です。これは、 Capybara は case insensivity をサポートしていない XPath をヘビーに使っているためです。 `

・@okitanさんの 「take a glance at capybara2.0」   https://docs.google.com/presentation/d/1FF302e39AzYGfq6gU9jDtP1rwLJowogb6Qv95VNaL8g/edit?pli=1#slide=id.p

・@netwillnetさんの 「Capybara 2.0 アップグレードガイド」
 http://willnet.in/24 

・Jenkins
 Jenkinsは、Javaで実装されたCI(継続的インテグレーションContinuous Integration)支援ツール

### 周辺ツール 
・Spork
　Sporkはdrubyを使ってRails環境をプレロードする高速化ツール

### 参考ツール 
・Cucumber
　Cucumber は日本語で書けるテストDSL

【テストツール構成図】

## 【Turnip入門】
◇ turnip本家
https://github.com/jnicklas/turnip 

◇ turnipインストール
Gemfile に呼び出しを追加して bundle実行します。RSpec環境があれば、基本的には、これだけです。

```
group :test do
  gem "turnip"
end
```

◇ turnipのステップファイルの所在を spec helperに記述。
```
Dir.glob("spec/**/*steps.rb") { |f| load f, true }
```


◇ turnip実行
 .featureファイルを引数にしてrspecを実行します。

```
$ rspec spec/hogehoge.feature
```


PS.) ちなみにCucumberの実行は
全体
$ rake cucumber
個別
$ bundle exec cucumber


## 【Turnipのテスト記述実装】
さてTurnipでテストを実行するには、次のfeatureファイルとstep定義ファイルの２種類のファイルを記述し実装する必要があります。

 feature ファイルは、機能(フィーチャ) を記述するファイルです。拡張子は.feature 。
内容は、機能、(ストーリー、)シナリオ、ステップ。日本語で書けます。
機能(feature)：
　アプリケーションの特長となる機能(群)。個々の機能だけではなく、特性や使い勝手など、ユーザにとって何らかの価値を提供できる単位で書く。
ストーリー (story)：機能(feature)の補足説明を記述する。
要するにコメントなので、無くてもOK
　
シナリオ (scenario)
機能(feature)を検証するためのテストシナリオ。要約した見出し。詳細は次のステップにて記述する。
ステップ (step)
テストシナリオでの操作や検証などの具体的なステップ。テスト実行時に、ステップで記述した内容に１対１で step_definitions ファイルにあるステップ定義スクリプトが実行される。

 step_definitions ファイルはステップ毎に具体的な動作をスクリプトで記述します。ファイル名はxxx_steps.rb 。
ステップ定義 (step_definitions)：ステップを実装したRubyスクリプト。


Gherkin書式は、Cucumberと共通です。






